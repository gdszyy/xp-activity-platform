_# XP通用活动平台产品设计文档_

**版本:** 2.0 (优化版)
**日期:** 2026年1月19日
**作者:** Manus AI

---

## 1. 核心设计思想 (v2.0)

在v1.0的基础上，我们采纳了关于提升灵活性的核心反馈，将产品设计思想从“单层模板+变量填空”升级为“**多层模板体系 + 组合式配置**”。这一思想旨在赋予运营人员最大的自主权，同时保证平台的规范性和稳定性。

### 1.1 多层模板体系

我们将模板体系解构为三个层次，实现了从“原子能力”到“业务场景”的逐级封装与复用。

1.  **原子模板 (Atomic Templates)**: 这是构成活动的最基础、可独立复用的业务单元。我们提供三类原子模板库：
    *   **任务模板库**: 预设各种常见的任务类型（如首充、签到、邀请）。
    *   **奖励模板库**: 预设各种标准化的奖励配置（如现金红包、优惠券）。
    *   **人群模板库**: 预设常用的目标用户分群（如新用户、高价值用户）。

2.  **活动模板 (Activity Template)**: 这是由研发或高阶运营设计的“**玩法框架**”。它通过组合多个原子模板，并利用LogicFlow编排它们之间的触发关系，形成一个完整的活动逻辑骨架。例如，一个“新手引导任务”活动模板可能包含了“注册任务”、“首充任务”和“首次分享任务”三个原子任务，以及对应的原子奖励。

3.  **活动实例 (Activity Instance)**: 这是由一线运营创建的，可以直接面向用户的具体活动。运营人员在创建活动实例时，**不仅可以填充活动模板暴露的变量，还可以根据实际需求，在模板框架的基础上，自由增删任务或奖励**，并灵活调整如活动时间、具体人群范围等非核心逻辑的配置。

### 1.2 设计优势

| 优势 | 描述 |
| :--- | :--- |
| **极致灵活性** | 运营可按需组合、增删任务和奖励，不再受限于固定模板，轻松应对多变的营销场景。 |
| **高度复用性** | 任务、奖励、人群等原子能力均可沉淀为模板，一次创建，处处复用，极大提升效率。 |
| **权责分离** | 研发/高阶运营负责构建稳定、通用的“活动模板”（保障核心逻辑），一线运营负责基于模板进行“组合式”创新（实现业务目标），权责清晰。 |

---

## 2. 产品功能架构 (v2.0)

整体功能架构依然遵循“配置后台、运行时服务、数据支撑”的三大模块划分，但对**配置后台**进行了深度重构，以支撑全新的多层模板体系。

### 2.1 配置后台 (Admin Portal)

配置后台现在是围绕“原子模板管理”和“活动组合配置”两个核心来组织的。

- **原子模板库管理 (Atomic Template Libraries)** - *(面向高阶用户/研发)*
    - **任务模板库**: 管理任务的触发、完成条件等逻辑。
    - **奖励模板库**: 管理奖励的类型、发放规则、预算等。
    - **人群模板库**: 管理用户标签的组合与筛选逻辑。

- **活动模板设计中心 (Activity Template Designer)** - *(面向高阶用户/研发)*
    - **可视化流程编排 (LogicFlow)**: 将**原子模板**作为画布中的“宏节点”，拖拽并连接它们，形成活动的主干逻辑流程。
    - **变量暴露配置**: 将原子模板中的参数及通用配置（如活动时间）暴露给活动创建者。

- **活动组合配置向导 (Activity Assembling Wizard)** - *(面向一线运营)*
    - **模板选择**: 选择一个“活动模板”作为起点。
    - **组合式配置**: 在向导中，可以**从原子模板库中拖入新的任务/奖励节点**，或删除模板中预设的节点。
    - **参数填充**: 为所有节点（包括新增的）填充具体的变量值。
    - **通用配置调整**: 灵活设置活动时间、最终的人群范围等。

- **通用管理与支撑功能**
    - 预览、校验、审计、数据看板等功能保持不变，但其实现会适应新的架构。

### 2.2 运行时服务 (Runtime Services) & 数据与可观测性 (Data & Observability)

这两大模块的宏观功能保持不变，但其内部实现需要进行相应升级，以解释和执行由多层模板组合生成的、更加动态和复杂的活动配置。


---

## 3. 信息架构与数据模型 (v2.0)

为了支撑全新的多层模板体系，我们对数据模型进行了重大升级。核心思路是**引入原子模板表，并重构活动实例的配置存储方式**，从“引用+变量”模式升级为“**配置快照**”模式。

### 3.1 核心设计原则 (v2.0)

- **原子化与可组合**: 将任务、奖励、人群等核心业务要素抽象为独立的“原子模板”，使其可以被任意组合和复用。
- **配置快照 (Configuration Snapshot)**: 活动实例在发布时，不再仅仅存储变量值，而是生成一个**完整、独立、不可变**的“已解析逻辑图 (`resolved_logic_graph`)”。这个JSON对象包含了该活动全部的、最终的执行逻辑。运行时服务只认这份“快照”，从而与上游的模板变更完全解耦，确保线上活动的绝对稳定。

### 3.2 核心数据表结构 (v2.0 E-R 模型)

我们在原有模型基础上，新增了三张原子模板表，并重构了活动实例表。

#### 3.2.1 原子模板表 (新增)

这三张表是构成活动的基础“积木”。

- **任务模板表 (task_template)**: 定义一个独立的任务玩法。
- **奖励模板表 (reward_template)**: 定义一个标准的奖励包。
- **人群模板表 (audience_template)**: 定义一个可复用的用户分群。

| 表名 | 核心字段 | 说明 |
| :--- | :--- | :--- |
| `task_template` | `id`, `name`, `task_type`, `config_schema` (JSON), `logic_definition` (JSON) | 定义任务的类型、可配参数和核心逻辑。 |
| `reward_template` | `id`, `name`, `reward_type`, `config_schema` (JSON), `logic_definition` (JSON) | 定义奖励的类型、可配参数和发放规则。 |
| `audience_template` | `id`, `name`, `rule_definition` (JSON) | 定义用户标签的组合筛选逻辑。 |

#### 3.2.2 核心业务表 (重构)

活动模板与活动实例的结构发生了核心变化。

- **活动模板表 (activity_template)**: 作为“玩法框架”，现在主要负责组合原子模板，并定义它们之间的连接关系。

| 字段名 | 数据类型 | 说明 |
| :--- | :--- | :--- |
| `id` | BIGINT | 模板唯一ID |
| `name` | VARCHAR(255) | 模板名称，如“新手引导任务框架” |
| `base_logic_graph` | JSON | **核心字段**。存储由“原子模板节点”构成的LogicFlow图，定义了玩法骨架。 |
| `exposed_variables_schema` | JSON | **核心字段**。定义此框架暴露给运营的全局配置项。 |

- **活动实例表 (activity_instance)**: 存储最终面向用户的活动，其核心是“配置快照”。

| 字段名 | 数据类型 | 说明 |
| :--- | :--- | :--- |
| `id` | BIGINT | 活动实例唯一ID |
| `name` | VARCHAR(255) | 活动实例名称，如“五一狂欢节” |
| `base_template_id` | BIGINT | **外键**。关联其起始的活动模板。 |
| `resolved_logic_graph` | JSON | **核心字段 (配置快照)**。存储最终合并、解析、填充完所有参数的、可直接执行的完整LogicFlow图。 |
| `common_meta` | JSON | 通用元数据，如活动起止时间、人群配置等。 |
| `status` | VARCHAR(50) | 状态（DRAFT, PUBLISHED, FINISHED, ARCHIVED） |

#### 3.2.3 关联与支撑表

`user_activity_context`, `reward_ledger`, `ranking_snapshot` 这三张表的设计保持不变，因为它们服务于运行时，而运行时的逻辑已经由 `resolved_logic_graph` 完全定义，对上游的模板结构变化无感知。


---

## 4. 页面流转与用户操作流程 (v2.0)

新的多层模板体系彻底改变了用户的操作心智，从“填空”转向“**搭积木**”。页面流转也相应地被重构成围绕“**原子模板管理**”和“**活动组合配置**”两大核心。

### 4.1 原子模板设计者 (高阶运营/研发) 核心流程

这类用户的核心任务是**创建和维护构成活动的基础“积木”**。他们的工作台是“原子模板库”。

**流程概述:**

1.  **进入原子模板库**: 从主导航进入“任务模板库”、“奖励模板库”或“人群模板库”。
2.  **创建/编辑原子模板**: 以创建任务模板为例：
    *   **选择任务类型**: 如“累计充值”、“邀请好友”。
    *   **配置核心逻辑**: 设置任务的触发和完成条件。
    *   **定义暴露变量**: 将需要运营填写的参数（如充值金额）定义为变量，并配置其前端UI。
    *   **保存模板**: 将配置好的任务存入“任务模板库”。
3.  **组合活动模板 (可选)**: 高阶用户还可以进入“活动模板设计中心”，将多个原子模板拖拽到画布上，连接它们的逻辑关系，形成一个“玩法框架”，并保存到活动模板库中。

### 4.2 活动创建者 (一线运营) 核心流程

这类用户的核心任务是**利用“积木”快速搭建和上线活动**。他们的工作台是“活动组合配置向导”，这是一个高度交互和可视化的界面。

**流程概述:**

1.  **启动向导**: 在活动列表页点击“创建活动”。
2.  **步骤一：选择起点**: 可以选择一个“活动模板”作为基础框架，也可以选择“从零开始”。
3.  **步骤二：组合与编排 (核心)**:
    *   进入一个可视化的配置界面，左侧是“任务/奖励/人群”等原子模板库，右侧是当前活动的配置面板。
    *   **添加任务/奖励**: 从左侧库中拖拽一个“任务模板”（如“首充任务”）到右侧面板中。
    *   **填充参数**: 在右侧面板中，为刚刚拖入的任务填写具体的变量值（如充值满100元）。
    *   **关联奖励**: 再从库中拖拽一个“奖励模板”（如“10元红包”）到该任务下方，表示完成任务后发放此奖励。
    *   **重复此过程**，直到活动的所有任务和奖励都配置完毕。
4.  **步骤三：配置通用信息**: 设置活动的起止时间、总预算、最终的目标人群等。
5.  **步骤四：预览与发布**: 与v1.0流程类似，进行沙盒预览、配置校验和发布操作。

**页面流转详情 (活动创建者):**

| 页面/组件 | 核心功能 | 主要操作 | 流转至 |
| :--- | :--- | :--- | :--- |
| **活动列表页** | 展示所有活动实例 | - 点击“创建活动” | - 活动组合配置向导 (步骤一) |
| **活动组合配置向导** | 可视化搭建活动 | **步骤一**: 选择起点<br>**步骤二**: 从库中拖拽原子模板进行组合与配置<br>**步骤三**: 设置通用信息<br>**步骤四**: 预览并发布 | - 步骤二<br>- 步骤三<br>- 步骤四<br>- 活动列表页 |


---

## 5. 核心架构与流程图 (v2.0)

以下图表直观地展示了v2.0设计方案的核心架构与用户工作流程。

### 5.1 多层模板体系架构图

该图清晰地展示了“原子模板”、“活动模板”和“活动实例”三个层次之间的关系，是新版设计的核心思想。

![多层模板体系架构图](diagrams/多层模板体系架构图.png)

### 5.2 数据模型 E-R 图 (v2.0)

新的数据模型引入了三张原子模板表，并重构了活动实例表以支持“配置快照”模式。

![数据模型ER图_v2](diagrams/数据模型ER图_v2.png)

### 5.3 原子模板设计者工作流

此流程图描述了高阶用户如何创建和管理构成活动的基础“积木”。

![原子模板设计者工作流](diagrams/原子模板设计者工作流.png)

### 5.4 活动创建者工作流 (v2.0)

此流程图展示了一线运营如何通过“搭积木”的方式，可视化地组合和配置一个完整的活动。

![活动创建者工作流_v2](diagrams/活动创建者工作流_v2.png)
