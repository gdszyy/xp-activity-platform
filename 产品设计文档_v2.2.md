_# XP通用活动平台产品设计文档_

**版本:** 2.2 (事件封装与变量体系重构)
**日期:** 2026年1月19日
**作者:** Manus AI

---

## 1. 核心设计思想 (v2.2)

在v2.1的基础上，我们根据您关于**事件灵活性**和**数据多样性**的深刻洞察，对平台的核心架构进行了再次重构。v2.2版本的设计核心是“**可派生的任务模板**”与“**统一数据上下文**”，旨在为运营提供前所未有的灵活性和逻辑清晰度。

### 1.1 可派生的任务模板

我们摒弃了过去由研发“硬编码”任务模板的模式。现在，一个任务模板可以由“**一个基础事件 + N个条件**”动态组合而成。运营人员可以在可视化界面中，从一个最原始的“投注事件”中，通过添加条件过滤，自行派生出“首次足球投注”、“首次串关投注”等无穷无尽的、符合业务需求的具体任务，实现了任务定义的完全自由。

### 1.2 统一数据上下文

我们建立了一个清晰的“**统一数据上下文 (Unified Data Context)**”模型。在ECA流程的每一个环节，所有可用的数据都被组织成一个结构化的对象，并通过**命名空间**进行严格区分，彻底解决了条件变量来源混乱的问题。

---

## 2. 信息架构与数据模型 (v2.2)

信息架构的核心升级是引入“统一数据上下文”模型，并对数据模型进行相应简化。

### 2.1 统一数据上下文 (Unified Data Context)

这是v2.2设计的基石。它是一个在活动运行时动态构建的、结构化的JSON对象，为所有ECA逻辑（特别是条件判断）提供了一个统一、无歧义的数据视图。该上下文通过四个核心命名空间来组织数据：

| 命名空间 | 数据来源 | 数据特征 | 示例 |
| :--- | :--- | :--- | :--- |
| `trigger` | **触发事件** | 包含了触发当前ECA流程的那个原始事件的所有信息。数据是瞬时的，仅在本次执行中有效。 | `trigger.bet_amount` (投注金额)<br>`trigger.sport` (体育项目) |
| `user` | **用户中心服务** | 包含了与当前用户相关的、相对静态的档案信息。通常在流程开始时获取一次。 | `user.vip_level` (VIP等级)<br>`user.kyc_level` (KYC等级)<br>`user.country` (用户国家) |
| `activity` | **活动自身状态** | 包含了用户在当前这个活动实例中的状态数据，如已完成任务次数、累积积分等。数据是活动维度的、可变的。 | `activity.task1_completed_count`<br>`activity.accumulated_points` |
| `external` | **外部API服务** | 包含了通过API从外部服务（如分享统计服务、风控服务等）实时获取的数据。 | `external.share_count_today`<br>`external.risk_score` |

#### 2.1.1 上下文的构建与使用

1.  **构建**: 当一个基础事件（如用户投注）发生时，活动运行时服务会启动ECA流程。它会首先将事件本身的数据填入 `trigger` 命名空间。
2.  **丰富**: 接着，运行时会根据活动配置，按需从用户中心、活动历史记录、外部API等处拉取数据，填充 `user`, `activity`, `external` 命名空间，最终形成一个完整的上下文对象。
3.  **使用**: 在执行ECA逻辑图时，每个“条件判断”节点的表达式都会在这个统一的上下文对象上进行求值（Evaluation）。例如，一个表达式 `user.vip_level >= 3 && trigger.bet_amount >= 100` 会被清晰、准确地解析和执行。

> **设计优势**: 这个模型通过**强制性的命名空间**，让运营人员在配置条件时，必须明确自己想要使用的数据来源，极大地提升了逻辑的健壮性和可维护性。同时也为平台未来的数据接入提供了清晰的扩展规范。

### 2.2 数据模型简化

根据您的要求，我们简化了数据模型的设计：

- **移除 `user_bonus_wallet` 表**: 不再在活动平台内部追踪Bonus的详细流水，这部分功能将由外部专业的钱包/账务系统负责。
- **移除 `reward_ledger` 表**: 奖励的发放记录也将由外部账务系统负责。活动平台在执行“奖励”动作时，仅负责**调用外部奖励服务提供的API接口**，并传递必要的参数（如 `user_id`, `reward_type`, `reward_value` 等）。

这种解耦使得活动平台更专注于其核心价值——**灵活、高效的营销活动配置与执行**，而将专业的账务和资金处理交还给更合适的系统。


---

## 3. 任务模板体系与事件封装 (v2.2)

为了解决v2.1中任务定义“硬编码”的僵化问题，我们引入了全新的“**可派生任务模板**”体系。该体系的核心是将“事件监听”与“条件过滤”解耦，赋予运营人员通过可视化配置，自行定义和派生新任务的能力。

### 3.1 体系构成

该体系由两个核心概念构成：

- **基础事件 (Base Events)**: 由平台研发团队预定义的、最原始的、不可再分的系统事件。它们是构成所有任务的“原子”。
- **复合任务模板 (Composite Task Templates)**: 由运营人员在“任务模板设计中心”创建的、可被活动引用的模板。它由“**一个基础事件 + N个条件**”组合而成。

### 3.2 基础事件 (Base Events)

基础事件由后端服务在关键业务动作发生时发出。平台会提供一个基础事件库供运营选择。

| 基础事件ID | 事件名称 | 触发时机 | 附带数据 (`trigger`命名空间) |
| :--- | :--- | :--- | :--- |
| `BASE_EVENT_USER_BET` | 用户投注事件 | 用户成功提交一笔注单时 | `bet_amount`, `sport`, `market_type`, `odds`, `is_parlay` (是否串关)等 |
| `BASE_EVENT_USER_DEPOSIT` | 用户充值事件 | 用户成功完成一笔充值时 | `deposit_amount`, `channel`, `is_first_deposit` |
| `BASE_EVENT_USER_LOGIN` | 用户登录事件 | 用户成功登录时 | `login_ip`, `device_type` |
| `BASE_EVENT_USER_SHARE` | 用户分享事件 | 用户在客户端点击分享按钮时 | `share_channel`, `page_url` |

### 3.3 复合任务模板 (Composite Task Templates)

这是v2.2设计的精髓。运营人员不再直接使用基础事件，而是通过组合它们来创建更具体的、有业务含义的“复合任务模板”。

#### 3.3.1 创建流程

运营人员在“任务模板设计中心”通过一个向导来创建复合任务模板：

1.  **选择基础事件**: 从基础事件库中选择一个作为触发器，例如 `BASE_EVENT_USER_BET`。
2.  **添加过滤条件**: 为这个基础事件添加一个或多个条件，以精确地定义任务的完成标准。这些条件表达式基于“统一数据上下文”进行求值。
3.  **定义输出**: 指定当任务完成时，需要向下游节点传递哪些数据。
4.  **保存为模板**: 为这个组合命名，并保存为一个新的复合任务模板。

#### 3.3.2 示例：创建“首次足球单式投注任务”

**目标**: 创建一个任务，用于识别用户历史上第一笔针对足球比赛的非串关投注。

**配置步骤:**

| 步骤 | 配置内容 |
| :--- | :--- |
| **1. 模板名称** | `首次足球单式投注任务` |
| **2. 选择基础事件** | `BASE_EVENT_USER_BET` (用户投注事件) |
| **3. 添加过滤条件** | 1. **条件一 (首次)**: `activity.task_completed_count == 0` (利用活动上下文，判断本地任务是否首次完成)<br>2. **条件二 (足球)**: `trigger.sport == 'football'`<br>3. **条件三 (单式)**: `trigger.is_parlay == false` |
| **4. 定义输出** | 将 `trigger.bet_amount` 和 `trigger.odds` 传递给下游节点。 |

通过以上配置，运营人员就成功地从一个泛化的“投注事件”中，派生出了一个高度特化的“**首次足球单式投注任务**” (`TPL_TASK_FIRST_FOOTBALL_SINGLE_BET`)。这个新创建的模板会自动出现在“任务模板库”中，可供任何活动随时调用。

> **设计优势**:
> - **无限灵活性**: 运营可以自由组合，创造出“首笔篮球串关投注”、“当日累计投注满5笔”、“首次在电竞项目上投注”等任意任务，无需研发介入。
> - **逻辑复用**: “首次”这个逻辑 (`activity.task_completed_count == 0`) 可以被复用到任何任务的定义中。
> - **关注点分离**: 研发团队只需关注提供稳定、全面的“基础事件”，而运营团队则专注于如何利用这些“积木”来创造有商业价值的“玩法”。
