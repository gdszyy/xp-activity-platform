erDiagram
    TASK_TEMPLATE ||--o{ ACTIVITY_TEMPLATE : "被组合"
    REWARD_TEMPLATE ||--o{ ACTIVITY_TEMPLATE : "被组合"
    AUDIENCE_TEMPLATE ||--o{ ACTIVITY_TEMPLATE : "被引用"
    
    ACTIVITY_TEMPLATE ||--o{ ACTIVITY_INSTANCE : "作为基础"
    
    TASK_TEMPLATE ||--o{ ACTIVITY_INSTANCE : "可增删"
    REWARD_TEMPLATE ||--o{ ACTIVITY_INSTANCE : "可增删"
    AUDIENCE_TEMPLATE ||--o{ ACTIVITY_INSTANCE : "可调整"
    
    ACTIVITY_INSTANCE ||--o{ USER_ACTIVITY_CONTEXT : "产生用户数据"
    ACTIVITY_INSTANCE ||--o{ REWARD_LEDGER : "记录发奖"
    ACTIVITY_INSTANCE ||--o{ RANKING_SNAPSHOT : "生成排名快照"
    
    TASK_TEMPLATE {
        bigint id PK
        varchar name
        varchar task_type
        json config_schema
        json logic_definition
        datetime created_at
    }
    
    REWARD_TEMPLATE {
        bigint id PK
        varchar name
        varchar reward_type
        json config_schema
        json logic_definition
        datetime created_at
    }
    
    AUDIENCE_TEMPLATE {
        bigint id PK
        varchar name
        json rule_definition
        int estimated_count
        datetime created_at
    }
    
    ACTIVITY_TEMPLATE {
        bigint id PK
        varchar name
        json base_logic_graph
        json exposed_variables_schema
        varchar status
        datetime created_at
    }
    
    ACTIVITY_INSTANCE {
        bigint id PK
        varchar name
        bigint base_template_id FK
        json resolved_logic_graph
        json common_meta
        varchar status
        datetime created_at
    }
    
    USER_ACTIVITY_CONTEXT {
        bigint id PK
        bigint activity_id UK
        varchar user_id UK
        json context_data
        int version
        datetime updated_at
    }
    
    REWARD_LEDGER {
        bigint id PK
        varchar transaction_id UK
        bigint activity_id IDX
        varchar user_id IDX
        varchar reward_type
        decimal reward_amount
        varchar status
        datetime created_at
    }
    
    RANKING_SNAPSHOT {
        bigint id PK
        bigint activity_id UK
        varchar period UK
        json ranking_data
        datetime snapshot_time
    }
