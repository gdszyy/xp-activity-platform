_# XP通用活动平台产品设计文档_

**版本:** 2.1 (巴西博彩版)
**日期:** 2026年1月19日
**作者:** Manus AI

---

## 1. 核心设计思想 (v2.1)

在v2.0的基础上，我们针对**巴西体育博彩**市场的业务特殊性和合规要求，对奖励体系和数据模型进行了关键升级。核心设计思想依然是“**多层模板体系 + 组合式配置**”，但其内涵，特别是原子模板层，已深度适配博彩业务场景。

### 1.1 奖励体系升级

我们将奖励原子模板从单一的现金模型，重构为支持博彩行业标准奖励类型的复合模型，以满足多样化的营销需求和合规要求。

- **Bonus (红利)**: 带有流水倍数、有效期等约束的奖励金，是激励用户持续投注的核心工具。
- **Freebet (免费投注)**: 特定面值的“投注券”，用于降低用户尝试新玩法的门槛。
- **Cash (现金)**: 可直接提现的奖励，作为高价值激励手段。

### 1.2 合规性增强

为满足巴西日益严格的博彩监管，我们增强了数据记录的完整性和可追溯性。每一笔奖励的生命周期（发放、使用、流转、过期）都将被精确追踪，确保所有操作都有据可查，以应对潜在的审计和反洗钱调查。

---

## 2. 产品功能架构 (v2.1)

功能架构的宏观划分保持不变，但**原子模板库管理**模块被深度重构，以支持新的奖励体系。

### 2.1 配置后台 (Admin Portal)

- **原子模板库管理 (Atomic Template Libraries)**
    - **任务模板库**: 保持不变。
    - **奖励模板库 (重构)**: 不再是单一的现金模板，而是提供了独立的 **Bonus模板库** 和 **Freebet模板库**，每个库都包含了丰富的、符合博彩业务逻辑的配置项。
    - **人群模板库**: 保持不变。

- **活动模板设计中心 & 活动组合配置向导**
    - 这两个模块的功能流程不变，但现在可以调用和组合新的Bonus和Freebet原子模板，从而搭建出符合博彩业务场景的活动。

---

## 3. 奖励原子模板体系 (v2.1)

这是本次升级的核心。我们为两种最核心的博彩奖励类型创建了专属的、高度可配置的原子模板。

### 3.1 Bonus (红利) 奖励模板

**模板ID: `TPL_REWARD_BONUS`**

该模板封装了发放“红利”这一核心能力，并暴露了所有博彩业务所需的关键参数，允许运营人员灵活配置红利规则。

**暴露变量 (配置Schema):**

| 变量名 | 显示名称 | 控件类型 | 说明 |
| :--- | :--- | :--- | :--- |
| `bonus_amount` | 红利金额 | NumberInput | 发放的红利面值。 |
| `wagering_multiplier` | 流水倍数 | NumberInput | 用户需完成多少倍于红利金额的有效投注额才能将红利转为现金。例如：值为5，则100元Bonus需要500元流水。 |
| `validity_period_days` | 有效期(天) | NumberInput | 红利从发放到过期的时间。 |
| `min_odds` | 最低赔率 | NumberInput | 只有投注于大于等于该赔率的选项，才被计入有效流水。默认-1为不限制。 |
| `applicable_games` | 适用游戏 | TagSelector | 指定该红利可用于哪些体育项目或游戏类型。默认为空则不限制。 |
| `kyc_level_required` | 最低KYC等级 | Dropdown | 指定领取该红利所需的用户最低KYC认证等级，用于合规。 |

### 3.2 Freebet (免费投注) 奖励模板

**模板ID: `TPL_REWARD_FREEBET`**

该模板封装了发放“免费投注券”的能力，运营可通过它配置各种类型的免费投注活动。

**暴露变量 (配置Schema):**

| 变量名 | 显示名称 | 控件类型 | 说明 |
| :--- | :--- | :--- | :--- |
| `freebet_value` | Freebet面值 | NumberInput | 这张免费投注券的金额。 |
| `return_type` | 返还类型 | Dropdown | - `STAKE_NOT_RETURNED` (仅返还净利润)<br>- `STAKE_RETURNED` (返还本金+利润) |
| `validity_period_days` | 有效期(天) | NumberInput | Freebet的有效使用期限。 |
| `min_odds` | 最低赔率 | NumberInput | 该Freebet可用于投注的最低赔率。 |
| `use_condition` | 使用条件 | Textarea | 描述Freebet使用的额外文本条件，如“仅限用于巴西甲级联赛的独赢盘口”。 |


---

## 4. 信息架构与数据模型 (v2.1)

为支撑新的奖励体系并满足合规要求，我们对数据模型进行了针对性扩展。

### 4.1 核心数据表结构 (v2.1 E-R 模型)

我们在v2.0模型的基础上，**扩展了发奖账本表**，并**新增了用户红利钱包与流水追踪表**。

#### 4.1.1 `reward_ledger` (发奖账本表) - 扩展

该表是所有奖励发放的起点，是审计的核心依据。我们为其增加一个JSON字段，用于固化存储发奖时刻的所有业务规则快照。

| 字段名 | 数据类型 | 说明 |
| :--- | :--- | :--- |
| ... | ... | ... |
| `reward_meta` | JSON | **(新增)** 存储该笔奖励的所有业务参数快照。例如，对于一笔Bonus，这里会记录`{"wagering_multiplier": 5, "validity_period_days": 30, "min_odds": 1.5}`。 |
| ... | ... | ... |

> **设计意图**: `reward_meta`字段确保了奖励规则的**不可篡改性**。即使后续运营修改了奖励模板，我们也能根据这个快照，准确追溯当时承诺给用户的具体奖励规则，这对于处理用户纠纷和满足监管审计至关重要。

#### 4.1.2 `user_bonus_wallet` (用户红利钱包与流水追踪表) - 新增

这张新表是本次升级的重中之重。它独立于用户的主钱包，专门用于精细化管理每一笔Bonus的生命周期。

| 字段名 | 数据类型 | 主键/索引 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | BIGINT | PK | 唯一ID |
| `user_id` | VARCHAR(64) | IDX | 用户ID |
| `reward_ledger_id` | BIGINT | FK | 关联到`reward_ledger`表中的发奖记录，追溯Bonus来源。 |
| `bonus_amount` | DECIMAL(18, 4) | | 初始发放的红利金额。 |
| `remaining_amount` | DECIMAL(18, 4) | | 当前剩余的红利金额（可能因投注消耗）。 |
| `wagering_requirement` | DECIMAL(18, 4) | | 需要完成的总流水要求 (bonus_amount * wagering_multiplier)。 |
| `completed_wagering` | DECIMAL(18, 4) | | 已完成的有效流水。 |
| `status` | VARCHAR(50) | IDX | **核心状态**: `ACTIVE` (激活), `COMPLETED` (流水完成), `EXPIRED` (已过期), `FORFEITED` (已作废)。 |
| `expires_at` | DATETIME | | 这笔Bonus的精确过期时间。 |
| `created_at` | DATETIME | | 创建时间 |
| `updated_at` | DATETIME | | 最后更新时间 |

> **设计意图**: 通过这张表，系统可以：
> 1.  **清晰追踪**: 用户的每一笔Bonus都有独立的生命周期和状态。
> 2.  **实时计算**: 在用户每次投注后，可以更新`completed_wagering`字段，实时计算流水进度。
> 3.  **自动处理**: 可以通过定时任务，扫描这张表，将`status`为`ACTIVE`且`expires_at`已过期的Bonus自动更新为`EXPIRED`状态。
> 4.  **合规对账**: 当Bonus状态变为`COMPLETED`时，系统会自动将其`remaining_amount`转入用户主钱包，并记录一笔内部账，资金流转清晰可查。

#### 4.1.3 Freebet 管理

对于Freebet，其管理相对简单，我们选择在`user_activity_context`表中进行记录，无需创建新表。

- 当用户获得Freebet时，在`user_activity_context`的`context_data`字段中记录：
  ```json
  "freebets": [
    {
      "freebet_id": "FB_98765",
      "value": 20,
      "status": "UNUSED",
      "expires_at": "2026-02-28 23:59:59"
    }
  ]
  ```
- 当用户使用或过期后，更新其`status`即可。这种方式对于生命周期较短、规则相对简单的Freebet来说，足够轻量和高效。
