_# XP通用活动平台设计优化分析 (v2.2)_

**版本:** 2.2
**日期:** 2026年1月19日
**作者:** Manus AI

---

## 1. 核心设计思想重构 (v2.2)

您提出的最新反馈触及了平台设计的两个核心瓶颈：**事件的灵活性**和**数据的多样性**。v2.1的设计虽然支持了复杂的奖励，但在“任务/事件”的定义上仍然是相对固化的，且未能清晰地区分条件判断中不同数据来源的差异。v2.2版本的设计将围绕解决这两个核心问题展开，进行一次深度的架构重构。

### 1.1 问题一：事件触发的“硬编码”问题

**现状**: 在v2.1中，“首充任务模板”是一个由研发预定义的、不可再分的原子单位。如果业务需要“首次足球投注任务”或“首次串关投注任务”，就需要研发人员重新开发新的任务模板。这种模式缺乏灵活性，无法跟上多变的运营需求。

**您的洞察**: 您提出“事件的触发也应该可以通过ECA封装”，这本质上是要求实现**事件的组合与派生**。我们不应只提供“最终事件”，而应提供“基础事件”和“组合工具”。

**解决方案 (v2.2)**: 我们将引入“**复合任务模板 (Composite Task Template)**”的概念。一个任务模板不再仅仅是监听一个底层事件，而是可以由“**一个基础事件 + N个条件**”组合而成。这样，运营人员自己就可以通过ECA的可视化界面，从一个最原始的“投注事件”中，派生出无穷无尽的、符合业务需求的具体任务。

> **类比**: 这就像从“面粉”（基础事件）中，可以制作出“面包”、“蛋糕”、“饼干”（派生任务），而不是由工厂定死只卖“面包”。

### 1.2 问题二：条件变量的“混沌”问题

**现状**: 在v2.1中，我们在条件判断中直接使用 `input.bet_amount` 或 `user.kyc_level` 等变量，但并未明确定义这些变量来自哪里、如何获取、生命周期是多久。这会导致逻辑混乱，难以维护和扩展。

**您的洞察**: 您敏锐地指出了变量来源的多样性：用户基础属性、外部模块数据、活动本身上下文数据等。

**解决方案 (v2.2)**: 我们将建立一个清晰的“**统一数据上下文 (Unified Data Context)**”模型。在ECA流程的每一个环节，所有可用的数据都将被组织成一个结构化的对象，并通过**命名空间**进行严格区分。条件表达式将基于这个统一上下文进行求值。

**统一数据上下文 (示例):**

```
{
  "trigger": { // 触发事件本身带来的数据
    "bet_amount": 100,
    "sport": "football",
    "market_type": "match_odds"
  },
  "user": { // 用户静态或半静态的档案数据
    "vip_level": 3,
    "kyc_level": 2,
    "country": "BR"
  },
  "activity": { // 当前活动实例的上下文数据 (状态)
    "task1_completed_count": 1,
    "accumulated_points": 50
  },
  "external": { // 通过API从外部服务获取的数据
    "share_count_today": 5
  }
}
```

通过这种方式，一个条件表达式 `user.vip_level >= 3 && activity.task1_completed_count > 0 && trigger.bet_amount >= 100` 就变得清晰、明确且无歧义。

---

## 2. 下一步工作

1.  **重构产品设计文档**: 将上述两大核心变更正式写入 `产品设计文档_v2.2.md`，重点重写“任务模板体系”和“信息架构”部分。
2.  **更新验证案例**: 将活动场景从“首充”改为“**首注**”，并使用新的“复合任务模板”和“统一数据上下文”模型，重新推演整个配置和测试流程。
3.  **简化奖励记录**: 根据您的要求，移除数据模型中关于奖励记录的详细设计，仅保留对外部奖励服务的调用接口定义。
